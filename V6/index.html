<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ingreso · Captura de Góndolas</title>
  <style>
  /* ===== Reset y normalización para alinear bordes ===== */
  *, *::before, *::after{ box-sizing:border-box }
  html, body{ height:100% }
  body{ margin:0; background:#0f172a; color:#e5e7eb; font-family:system-ui,-apple-system,Segoe UI,Roboto }

  :root{ --pad-card:20px; --gap:12px; --radius-card:16px; --radius-ctl:12px; --blue:#2563eb }

  /* Header fijo */
  .app-header{ position:fixed; inset:0 0 auto 0; z-index:1000; display:flex; align-items:center; gap:12px; padding:8px 12px; background:#0b1220; border-bottom:1px solid #202a44 }
  .app-header img{ height:28px; width:auto }
  .header-info{ display:flex; flex-direction:column }
  .header-info strong{ font-size:14px }

  .main{ padding-top:60px }
  .wrap{ max-width:520px; margin:0 auto; padding:16px }

  .card{ background:#0b1220; border:1px solid #202a44; border-radius:var(--radius-card); padding:var(--pad-card) }
  .card h1{ margin:0 0 16px 0 }

  /* ===== Form como grid para 100% exacto ===== */
  .form{ display:grid; grid-template-columns:1fr; row-gap:var(--gap) }
  .form label{ font-size:14px; color:#94a3b8; margin:0 }
  .form input{ width:100%; display:block; padding:12px 14px; border-radius:var(--radius-ctl); border:1px solid #29324c; background:#0e1629; color:#e5e7eb; font-size:16px; margin:0 }

  /* Botón centrado dentro de la tarjeta */
  .actions{ display:flex; justify-content:center; margin-top:var(--gap) }
  .btn{ border:0; background:var(--blue); color:white; border-radius:12px; padding:12px 16px; font-size:16px; font-weight:600; cursor:pointer; min-width:180px }

  .status{ margin-top:12px; font-size:14px; color:#94a3b8; min-height:1.2em; text-align:left }
  .muted{ font-size:12px; color:#93a3c0; margin-top:10px }

  /* FAB opcional (cuando formulario es válido) */
  :root{ --fab-size:52px; --fab-bottom:max(18px, env(safe-area-inset-bottom) + 18px) }
  .fab{ position:fixed; left:50%; bottom:var(--fab-bottom); transform:translateX(-50%); width:var(--fab-size); height:var(--fab-size); border-radius:999px; background:var(--blue); color:#fff; border:0; display:none; place-items:center; z-index:1200; box-shadow:0 8px 28px rgba(0,0,0,.35) }
  .fab svg{ width:22px; height:22px }
  .fab.show{ display:grid }

  /* Evitar desalineaciones por scrollbar vertical (estético) */
  html{ scrollbar-gutter: stable both-edges }
  </style>
</head>
<body>
  <header class="app-header">
    <img src="logo-traverso.webp" alt="Traverso" />
    <div class="header-info">
      <strong>Auditoría Góndolas</strong>
      <span class="muted">Ingreso</span>
    </div>
  </header>

  <div class="main">
    <div class="wrap">
      <div class="card">
        <h1>Ingreso</h1>

        <div class="form">
          <label for="user">Usuario</label>
          <input id="user" autocomplete="username" />

          <label for="pass">Contraseña</label>
          <input id="pass" type="password" autocomplete="current-password" />

          <label for="room">N° de sala</label>
          
<input id="room"
       type="text"
       autocomplete="off"
       spellcheck="false"
       maxlength="50"
       placeholder="ej: A01" />

        </div>

        <div class="actions">
          <button id="go" class="btn">Tomar fotos</button>
        </div>

        <div class="status" id="msg"></div>
        <div class="muted">Al continuar, la cámara se iniciará automáticamente en la siguiente pantalla.</div>
      </div>
    </div>
  </div>

  <!-- FAB alternativo: centrado inferior (visible solo si el formulario está válido) -->
  <button id="fabGo" class="fab" title="Tomar fotos" aria-label="Tomar fotos">
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 4l1.5-2h3L15 4h3a3 3 0 013 3v9a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h3z" stroke="#fff" stroke-width="1.6"/><circle cx="12" cy="12" r="3.2" fill="#fff"/></svg>
  </button>

<script>
// ====== NEAREST ROOM (se mantiene) ======
const NEAREST_ROOM_URL = "https://defaultab52009f566c40d1940686e6a61980.d1.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/46e407b51df54c10913b688a04e58952/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=jRqVv7H43uLfquHMkXUPNKz6cm5vB18elZEX6_EdHKc";
const MAX_METERS_DEFAULT = 1500;

const $user = document.getElementById('user');
const $pass = document.getElementById('pass');
const $room = document.getElementById('room');
const $go   = document.getElementById('go');
const $fab  = document.getElementById('fabGo');
const $msg  = document.getElementById('msg');

function status(t, ok=true){ $msg.textContent=t; $msg.style.color=ok?'#a7f3d0':'#fecaca'; }

  /* function normalizeRoom(v){ return (v||'').toUpperCase().trim().replace(/\s+/g,''); } */

// ✅ NUEVA implementación: por defecto NO toca el valor
function normalizeRoom(v, {
  toUpper = false,
  trim = false,
  removeSpaces = false
} = {}) {
  let out = (v ?? '');
  if (trim) out = out.trim();
  if (removeSpaces) out = out.replace(/\s+/g, '');
  if (toUpper) out = out.toUpperCase();
  return out;
}

/* function isValidRoom(v){ return /^[A-Z0-9\-]{1,50}$/.test(v); } */

  
// ✅ Validación cruda: solo que no esté vacío y que no pase de 50 chars
function isValidRoom(v) {
  return typeof v === 'string' && v.length > 0 && v.length <= 50;
}



(function preload(){ try{ $user.value = sessionStorage.getItem('gl_user')||''; $room.value = sessionStorage.getItem('gl_room')||''; }catch{} refreshFab(); })();
function formValid(){ const u=($user.value||'').trim(); const p=($pass.value||'').trim(); const r=normalizeRoom($room.value); return !!(u && p && isValidRoom(r)); }
function refreshFab(){ $fab.classList.toggle('show', formValid()); }
$user.addEventListener('input', refreshFab);
$pass.addEventListener('input', refreshFab);
$room.addEventListener('input', ()=>{ $room.value = normalizeRoom($room.value); refreshFab(); });

function goCapture(){ const u = ($user.value||'').trim(); const p = ($pass.value||'').trim(); const r = normalizeRoom($room.value); if(!u || !p || !isValidRoom(r)){ status('Completa usuario, contraseña y sala válida (A-Z, 0-9, "-").', false); return; } try{ sessionStorage.setItem('gl_user', u); sessionStorage.setItem('gl_pass', p); sessionStorage.setItem('gl_room', r); }catch{} location.href = './capture.html?t=' + Date.now(); }
$go.onclick = goCapture; $fab.onclick = goCapture;

async function nearestRoom(lat, lng, maxMeters = MAX_METERS_DEFAULT){ try{ const res = await fetch(NEAREST_ROOM_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain; charset=utf-8' }, body: JSON.stringify({ lat, lng, maxMeters }) }); const data = await res.json().catch(()=>({})); console.log('NearestRoom →', res.status, data); return { ok: res.ok && data && data.ok === true, data, status: res.status }; }catch(e){ console.log('NearestRoom error →', e); return { ok:false, error:e.message }; } }
function getLocationOnce(options){ return new Promise((resolve, reject)=>{ if(!('geolocation' in navigator)) return reject(new Error('Geolocalización no soportada')); navigator.geolocation.getCurrentPosition(pos=>resolve(pos), err=>reject(err), { enableHighAccuracy:true, timeout:10000, maximumAge:0, ...(options||{}) }); }); }

(async function autoSuggestRoom(){ try{ status('Buscando sala cercana…'); const pos = await getLocationOnce(); const { latitude: lat, longitude: lng, accuracy } = pos.coords; if (accuracy && accuracy > 100) status(`Precisión limitada (${Math.round(accuracy)} m). Buscando…`); const r = await nearestRoom(lat, lng, MAX_METERS_DEFAULT); if(!r.ok){ status(`No se pudo sugerir sala (HTTP ${r.status||''}). Ingresa manualmente.`, false); return; } const s = r.data && r.data.sala ? r.data.sala : null; if(!r.data.found || !s || !s.roomCode){ status('No hay salas dentro del radio. Ingresa manualmente.', false); return; } $room.value = normalizeRoom(s.roomCode); try{ sessionStorage.setItem('gl_room', $room.value); }catch{} const dist = typeof s.distanceMeters==='number' ? `${Math.round(s.distanceMeters)} m` : ''; status(`Sala sugerida: ${$room.value}${dist? ' · '+dist:''}`); refreshFab(); }catch(e){ status(`Geo/flujo no disponible: ${e.message}. Ingresa sala manualmente.`, false); } })();
</script>
</body>
</html>
