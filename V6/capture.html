<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cámara · Captura de Góndolas</title>
  <style>
  body{margin:0;background:#0f172a;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  /* Header fijo */
  .app-header{position:fixed;top:0;left:0;right:0;z-index:1000;display:flex;align-items:center;gap:12px;padding:8px 12px;background:#0b1220;border-bottom:1px solid #202a44}
  .app-header img{height:28px;width:auto}
  .header-info{display:flex;flex-direction:column}
  .header-info strong{font-size:14px}
  .main{padding-top:60px}

  .wrap{max-width:720px;margin:0 auto;padding:16px}
  .card{background:#0b1220;border:1px solid #202a44;border-radius:16px;padding:16px}
  h1{margin:0 0 8px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .status{margin-top:12px;font-size:14px;color:#94a3b8}
  #gallery{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:12px}
  .thumb{position:relative;border:1px solid #223;border-radius:10px;overflow:hidden}
  .thumb img{width:100%;display:block}
  .thumb button{position:absolute;top:4px;right:4px;background:#1f2937;color:#fff;border:0;border-radius:8px;padding:4px 6px;cursor:pointer}
  .videoWrap{position:relative;border-radius:16px;overflow:hidden;border:1px solid #223;background:black;margin-bottom:12px}
  .videoWrap[data-ar="4:3"]{aspect-ratio:4/3;}
  .videoWrap video{width:100%;height:100%;object-fit:cover;display:block}
  .overlay{position:absolute;inset:0;pointer-events:none;border-radius:16px;box-shadow: inset 0 0 0 2px rgba(255,255,255,.15);background:
    linear-gradient(rgba(255,255,255,.18), rgba(255,255,255,.18)) 33.333% 0 / 1px 100% no-repeat,
    linear-gradient(rgba(255,255,255,.18), rgba(255,255,255,.18)) 66.666% 0 / 1px 100% no-repeat,
    linear-gradient(rgba(255,255,255,.18), rgba(255,255,255,.18)) 0 33.333% / 100% 1px no-repeat,
    linear-gradient(rgba(255,255,255,.18), rgba(255,255,255,.18)) 0 66.666% / 100% 1px no-repeat;
    outline: 800px solid rgba(0,0,0,.0);
  }
  .fab{position:absolute;left:50%;transform:translateX(-50%);bottom:18px;width:76px;height:76px;border-radius:50%;background:#ffffff;color:#0b1220;border:0;display:grid;place-items:center;cursor:pointer}
  .fab:active{ transform:translateX(-50%) scale(0.96) }
  .flash{ position:absolute; inset:0; pointer-events:none; border-radius:16px; background:#fff; opacity:0 }
  .flash.on{ animation: flashBlink 140ms ease-in-out forwards }
  @keyframes flashBlink{ 0%{opacity:.9} 100%{opacity:0} }
  .zoomBar{display:flex;align-items:center;gap:10px;margin-top:8px}
  .zoomBar input[type="range"]{width:100%}
  .zoomBar .tag{font-size:12px;color:#a3bffa}
  .perm{position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45)}
  .perm .box{background:#0b1220;border:1px solid #223;border-radius:14px;padding:16px;max-width:90%;text-align:center}
  .perm p{margin:0 0 10px 0;color:#cbd5e1;font-size:14px}
  .perm button{border:0;background:#22c55e;color:#fff;border-radius:12px;padding:10px 12px;font-weight:600;cursor:pointer}
  .diag{margin-top:14px;background:#0a1222;border:1px dashed #2a365a;border-radius:12px;padding:12px}
  .diag h3{margin:0 0 8px 0;font-size:14px;color:#a3bffa}
  .diag pre{white-space:pre-wrap;word-wrap:break-word;background:#0a1329;border:1px solid #1d2847;border-radius:8px;padding:10px;max-height:220px;overflow:auto}
  .muted{font-size:12px;color:#93a3c0;margin-top:10px}
  .row button.secondary{background:#1f2937;color:#cbd5e1}
  </style>
</head>
<body>
  <header class="app-header">
    <img src="logo-traverso.webp" alt="Traverso" />
    <div class="header-info">
      <strong>Auditoría Góndolas</strong>
      <span class="muted" id="who">Usuario · Sala</span>
    </div>
  </header>

<div class="main">
<div class="wrap"><div class="card">
  <div class="videoWrap" data-ar="4:3">
    <video id="camera" autoplay playsinline muted></video>
    <canvas id="snapshot" style="display:none"></canvas>
    <button id="btnShutter" class="fab" aria-label="Capturar" onclick="capture()">●</button>
    <div id="flash" class="flash" aria-hidden="true"></div>
    <div id="perm" class="perm" aria-live="polite">
      <div class="box">
        <p>Permite acceso a la cámara para comenzar.</p>
        <button onclick="manualStart()">Permitir cámara</button>
      </div>
    </div>
    <div class="overlay"></div>
  </div>
  <div class="zoomBar" id="zoomBar" hidden>
    <span class="tag">Zoom</span>
    <input type="range" id="zoom" min="1" max="1" step="0.1" value="1" />
    <span id="zoomVal" class="tag">1.0×</span>
  </div>
  <div class="row" style="margin-top:10px">
    <button id="btnSendBatch" onclick="(async()=>{await buildAndStageBatches();status('Enviando lote…');await sendOutboxWithRetry();triggerBGSync();})()">Enviar lote</button>
    <button id="btnRetry" class="secondary" onclick="sendOutboxWithRetry()">Reintentar ahora</button>
    <button id="btnChange" class="secondary" onclick="logout()">Cambiar sala / salir</button>
  </div>
  <div id="gallery"></div>
  <div class="status"><span id="msg">Listo</span><br/><span id="queueMsg">Cola: 0 fotos pendientes · Lotes en envío: 0</span></div>
  <div class="diag" id="diag" style="display:none">
    <h3>Diagnóstico</h3>
    <div class="row">
      <button class="secondary" onclick="showOutbox()">Ver outbox</button>
      <button class="secondary" onclick="forceUpdate()">Forzar actualización (limpiar SW/Cache)</button>
      <button class="secondary" onclick="testAuth()">Probar credenciales</button>
    </div>
    <pre id="log"></pre>
  </div>
</div></div>
</div>

<script>
// ===== Config =====
const FLOW_UPLOAD_URL = "https://defaultab52009f566c40d1940686e6a61980.d1.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/51a6e085ab6f40338b007d0b0925eaa9/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=XRRtlLgS7mtHs9PjkE64NpUyuvbDQXUoe9rP1VawKsc";
const TARGET_AR = 4/3;
const MAX_DIM = 2048;
const JPEG_QUALITY = 0.90;
const BATCH_MAX_IMAGES = 5;
const RETRY_BASE_MS = 2000, RETRY_MAX_MS = 60000;
const AUTO_START_CAMERA = true;
const DIAG = new URLSearchParams(location.search).get('diag')==='1';

const $video = document.getElementById('camera');
const $zoomBar = document.getElementById('zoomBar');
const $zoom = document.getElementById('zoom');
const $zoomVal = document.getElementById('zoomVal');
const $gallery = document.getElementById('gallery');
const $queueMsg = document.getElementById('queueMsg');
const $msg = document.getElementById('msg');
const $log = document.getElementById('log');
const $diag = document.getElementById('diag');
const $perm = document.getElementById('perm');
const $who = document.getElementById('who');
let stream=null, photoReady=false, currentJpegB64=null;

function status(t, ok=true){ $msg.textContent=t; $msg.style.color=ok?'#a7f3d0':'#fecaca'; if(DIAG) log(t); }
function log(...args){ if(!$log) return; const s = args.map(a=> typeof a==='string'? a : JSON.stringify(a)).join(' '); $log.textContent += (s+'\n'); $log.scrollTop = $log.scrollHeight; }
function normalizeRoom(v){ return (v||'').toUpperCase().trim().replace(/\s+/g,''); }
function getUser(){ return sessionStorage.getItem('gl_user')||''; }
function getPass(){ return sessionStorage.getItem('gl_pass')||''; }
function getRoom(){ return sessionStorage.getItem('gl_room')||''; }
if (DIAG) $diag.style.display = 'block';

let __ac; 
async function playShutterSound(){ try{ __ac = __ac || new (window.AudioContext||window.webkitAudioContext)(); if(__ac.state==='suspended'){ await __ac.resume(); } const o=__ac.createOscillator(), g=__ac.createGain(); o.type='square'; o.frequency.setValueAtTime(980,__ac.currentTime); o.frequency.exponentialRampToValueAtTime(440,__ac.currentTime+0.06); g.gain.setValueAtTime(0.0001,__ac.currentTime); g.gain.exponentialRampToValueAtTime(0.2,__ac.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,__ac.currentTime+0.09); o.connect(g).connect(__ac.destination); o.start(); o.stop(__ac.currentTime+0.10); }catch(e){} }
function triggerFlash(){ const el=document.getElementById('flash'); if(!el) return; el.classList.remove('on'); void el.offsetWidth; el.classList.add('on'); }

async function startCamera(){
  try { if (stream) stream.getTracks().forEach(t=>t.stop()); } catch {}

  const trials = [
    { video: { facingMode:{ideal:'environment'}, width:{ideal:2560}, height:{ideal:1920}, aspectRatio:{ideal:TARGET_AR} }, audio:false },
    { video: { facingMode:{ideal:'environment'}, width:{ideal:2048}, height:{ideal:1536}, aspectRatio:{ideal:TARGET_AR} }, audio:false },
    { video: { facingMode:{ideal:'environment'}, width:{ideal:1920}, height:{ideal:1080} }, audio:false },
    { video: { facingMode:{ideal:'environment'} }, audio:false },
    { video: true, audio:false }
  ];

  for (const c of trials){
    try{
      status('Iniciando cámara…');
      stream = await navigator.mediaDevices.getUserMedia(c);
      $video.srcObject = stream;
      try{ await $video.play(); }catch{}
      await new Promise(res=>{ const tid=setTimeout(res,1200); $video.onloadedmetadata=()=>{clearTimeout(tid);res();}; });
      if(!$video.videoWidth || !$video.videoHeight) throw new Error('Video sin dimensiones');
      status('Cámara lista');
      $perm.style.display='none';
      setupZoomUI(stream);
      await setupFocusIfAvailable(stream);
      return true;
    }catch(e){ log('startCamera error:', e.name||e, e.message||''); }
  }

  status('No se pudo iniciar la cámara. Autoriza el permiso.', false);
  $perm.style.display='flex';
  return false;
}

async function manualStart(){ $perm.style.display='none'; const ok = await startCamera(); if(!ok) $perm.style.display='flex'; }

async function setupFocusIfAvailable(stream){
  try{
    const track = stream.getVideoTracks()[0];
    const caps = track.getCapabilities?.() || {};
    const advanced = [];
    if (caps.focusMode && caps.focusMode.includes('continuous')) advanced.push({ focusMode: 'continuous' });
    if (caps.exposureMode && caps.exposureMode.includes('continuous')) advanced.push({ exposureMode: 'continuous' });
    if (advanced.length) { await track.applyConstraints({ advanced }); log('Focus/exposure constraints applied:', advanced); }
  }catch(e){ log('setupFocusIfAvailable error:', e.message); }
}

function setupZoomUI(stream){
  const track=stream.getVideoTracks()[0];
  const caps=track.getCapabilities?.()||{}, settings=track.getSettings?.()||{};
  if ('zoom' in caps && typeof caps.zoom.min==='number'){
    document.getElementById('zoomBar').hidden=false; const min=caps.zoom.min??1, max=caps.zoom.max??1, step=caps.zoom.step||0.1, cur=settings.zoom??min;
    $zoom.min=min; $zoom.max=max; $zoom.step=step; $zoom.value=cur; $zoomVal.textContent=`${Number(cur).toFixed(1)}×`;
    $zoom.oninput=async ()=>{ const z=Number($zoom.value); $zoomVal.textContent=`${z.toFixed(1)}×`; try{ await track.applyConstraints({advanced:[{zoom:z}]}); }catch(e){ log('zoom',e.message);} };
  }else{ document.getElementById('zoomBar').hidden=true; }
}

async function waitForVideoDims(maxTries=15, delayMs=120){ for(let i=0;i<maxTries;i++){ if($video.videoWidth&&$video.videoHeight)return true; await new Promise(r=>setTimeout(r,delayMs)); } return !!($video.videoWidth&&$video.videoHeight); }
function getOrCreateCanvas(){ let cv=document.getElementById('snapshot'); if(cv&&cv.getContext) return cv; cv=document.createElement('canvas'); cv.id='snapshot'; cv.style.display='none'; (document.querySelector('.videoWrap')||document.body).appendChild(cv); return cv; }

async function capture(){
  try{
    status('Capturando…');
    if(!(await waitForVideoDims())){ status('Cámara sin dimensiones aún. Intenta nuevamente.', false); return; }

    const vw=$video.videoWidth, vh=$video.videoHeight;
    const videoAR = vw/vh;
    let sx, sy, sw, sh;
    if (videoAR > TARGET_AR) { sh = vh; sw = Math.round(sh * TARGET_AR); sx = Math.round((vw - sw)/2); sy = 0; }
    else { sw = vw; sh = Math.round(sw / TARGET_AR); sx = 0; sy = Math.round((vh - sh)/2); }

    const longSide = Math.max(sw, sh);
    const scale    = longSide > MAX_DIM ? (MAX_DIM / longSide) : 1;
    const tw       = Math.round(sw * scale);
    const th       = Math.round(sh * scale);

    const canvas = getOrCreateCanvas();
    canvas.width=tw; canvas.height=th;
    const ctx = canvas.getContext('2d', {alpha:false});
    ctx.imageSmoothingEnabled = false;
    await new Promise(r=>requestAnimationFrame(r));
    ctx.drawImage($video, sx, sy, sw, sh, 0, 0, tw, th);

    let dataUrl = canvas.toDataURL('image/jpeg', JPEG_QUALITY);
    if(!dataUrl || dataUrl.length<50){ await new Promise(r=>setTimeout(r,120)); ctx.drawImage($video, sx, sy, sw, sh, 0, 0, tw, th); dataUrl = canvas.toDataURL('image/jpeg', JPEG_QUALITY); }
    if(!dataUrl || dataUrl.length<50){ status('No se pudo capturar la imagen. Reintenta.', false); return; }

    playShutterSound(); triggerFlash(); if(navigator.vibrate) navigator.vibrate(30);

    const base64 = dataUrl.split(',')[1];
    currentJpegB64 = base64; photoReady = true;

    await addCurrentPhotoToQueue();
    status(`Foto agregada (${tw}×${th} · 4:3). Lista para la siguiente.`);

  }catch(e){ status(`Error capturando: ${e.message}`, false); }
}

// ===== IndexedDB / cola / lotes / envío =====
let db;
function openDB(){ return new Promise((res,rej)=>{ const req=indexedDB.open('auditoria-gondolas-db',1); req.onupgradeneeded=e=>{ const d=e.target.result; if(!d.objectStoreNames.contains('captures')) d.createObjectStore('captures',{keyPath:'image_id'}); if(!d.objectStoreNames.contains('outbox')) d.createObjectStore('outbox',{keyPath:'batch_id'}); if(!d.objectStoreNames.contains('processed')) d.createObjectStore('processed',{keyPath:'image_id'}); }; req.onsuccess=()=>{db=req.result;res(db)}; req.onerror=()=>rej(req.error); }); }
function tx(store,mode='readonly'){ return db.transaction(store, mode).objectStore(store); }
function put(store,val){ return new Promise((res,rej)=>{const r=tx(store,'readwrite').put(val); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error);}); }
function del(store,key){ return new Promise((res,rej)=>{const r=tx(store,'readwrite').delete(key); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error);}); }
function getAll(store){ return new Promise((res,rej)=>{const r=tx(store).getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>rej(r.error);}); }
const uuid=()=> crypto.randomUUID? crypto.randomUUID():('id-'+Date.now()+'-'+Math.random().toString(16).slice(2));

async function refreshGallery(){ const items = await getAll('captures'); $gallery.innerHTML=''; for (const it of items){ const d=document.createElement('div'); d.className='thumb'; d.innerHTML = `\n <img alt="foto" src="data:image/jpeg;base64,${it.image_base64}" />\n <button title="Quitar" data-id="${it.image_id}">✕</button>`; d.querySelector('button').onclick=async (e)=>{ await del('captures', e.target.dataset.id); await refreshGallery(); await updateQueueState(); }; $gallery.appendChild(d);} document.getElementById('btnSendBatch').disabled = items.length===0; }
async function updateQueueState(){ const cap=await getAll('captures'); const out=await getAll('outbox'); $queueMsg.textContent=`Cola: ${cap.length} fotos pendientes · Lotes en envío: ${out.length}`; }

async function addCurrentPhotoToQueue(){ const user=getUser(), pass=getPass(), room=normalizeRoom(getRoom()); if(!user||!pass||!room){ status('Sesión no válida. Volver a inicio.', false); return; } if(!photoReady||!currentJpegB64){ status('Captura una foto primero', false); return; } const image = { image_id: uuid(), room_code: room, user, client_time: new Date().toISOString(), device: { ua:navigator.userAgent, platform:navigator.platform, lang:navigator.language }, image_base64: currentJpegB64 }; try{ await put('captures', image); photoReady=false; currentJpegB64=null; await refreshGallery(); await updateQueueState(); }catch(e){ status('No se pudo guardar en cola', false); } }

async function buildAndStageBatches(){ const items = await getAll('captures'); if(items.length===0) return; const groups = new Map(); for(const it of items){ const key=`${it.user}::${it.room_code}`; if(!groups.has(key)) groups.set(key,[]); groups.get(key).push(it); } for (const [key, arr] of groups){ const [user, room_code] = key.split('::'); for(let i=0;i<arr.length;i+=BATCH_MAX_IMAGES){ const chunk=arr.slice(i,i+BATCH_MAX_IMAGES); const batch={ batch_id: uuid(), room_code, user, created_at: new Date().toISOString(), images: chunk.map(({ image_id, image_base64, client_time, device }) => ({ image_id, image_base64, client_time, device })) }; await put('outbox', batch); for(const it of chunk) await del('captures', it.image_id); } } await refreshGallery(); await updateQueueState(); }

async function sendOutboxOnce(){ const user=getUser(), pass=getPass(); const batches = await getAll('outbox'); for(const b of batches){ try{ const res = await fetch(FLOW_UPLOAD_URL, { method:'POST', headers:{ 'Content-Type':'text/plain; charset=utf-8' }, body: JSON.stringify({ user, password: pass, room_code: b.room_code, batch_id: b.batch_id, images: b.images }) }); const text = await res.text(); let data; try{ data = JSON.parse(text); }catch{ data={ ok:res.ok, raw:text }; } if(res.ok && data.ok){ const okIds = new Set((data.results||[]).filter(r=>r.ok).map(r=>r.image_id)); for(const img of b.images) if(okIds.has(img.image_id)) await put('processed',{image_id:img.image_id, ts:Date.now()}); await del('outbox', b.batch_id); status(`Lote ${b.batch_id} enviado (${(data.results||[]).length} fotos).`); }else{ status(`Error HTTP ${res.status}`, false); throw new Error(`HTTP ${res.status}`); } }catch(e){ status(`Error enviando ${b.batch_id}. Reintento en ${Math.round(backoff/1000)}s…`, false); } } await updateQueueState(); }
let backoff=RETRY_BASE_MS; async function sendOutboxWithRetry(){ await sendOutboxOnce(); const out=await getAll('outbox'); if(out.length===0){ backoff=RETRY_BASE_MS; return; } backoff=Math.min(backoff*2, RETRY_MAX_MS); setTimeout(sendOutboxWithRetry, backoff); }
async function triggerBGSync(){ sendOutboxWithRetry(); if('serviceWorker' in navigator && 'SyncManager' in window){ try{ const reg=await navigator.serviceWorker.ready; await reg.sync.register('sync-outbox'); }catch{} } }

async function testAuth(){ const user=getUser(), pass=getPass(), room=getRoom(); status('Probando credenciales…'); try{ const res=await fetch(FLOW_UPLOAD_URL,{method:'POST',headers:{'Content-Type':'text/plain; charset=utf-8'}, body:JSON.stringify({user,password:pass,room_code:room,images:[]})}); const txt=await res.text(); log('Auth → HTTP',res.status,txt); status(res.status===200?'Credenciales OK':(res.status===401?'Credenciales incorrectas':'Auth HTTP '+res.status), res.status===200); }catch(e){ log('Auth error:',e.message); status('Error de red en auth',false);} }
async function showOutbox(){ const out=await getAll('outbox'); log('Outbox:', out.length, out); }
async function forceUpdate(){ try{ if('caches' in window){ const keys=await caches.keys(); for(const k of keys) if(k.startsWith('gondolas-')) await caches.delete(k); } if(navigator.serviceWorker){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); } location.reload(); }catch(e){ log('forceUpdate error:', e.message); } }
function logout(){ try{ sessionStorage.removeItem('gl_user'); sessionStorage.removeItem('gl_pass'); sessionStorage.removeItem('gl_room'); }catch{} location.href='./index.html?t='+Date.now(); }

openDB().then(()=>{ refreshGallery(); updateQueueState(); });
if('serviceWorker' in navigator){ const base = location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^/]+$/, ''); navigator.serviceWorker.register(`${base}sw.js`, { scope: base }).catch(()=>{}); }
document.addEventListener('DOMContentLoaded', async ()=>{ const u=getUser(), r=getRoom(); document.getElementById('who').textContent = (u&&r)? `Usuario: ${u} · Sala: ${r}` : 'Sesión no cargada'; if(!u || !getPass() || !r){ status('Faltan datos de sesión. Volver a inicio.', false); document.getElementById('perm').style.display='flex'; return; } if(AUTO_START_CAMERA){ const ok=await startCamera(); if(!ok){ document.getElementById('perm').style.display='flex'; } } });
</script>
</body>
</html>