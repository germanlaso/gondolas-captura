<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ingreso | Captura de Góndolas</title>
  <style>
    body{margin:0;background:#0f172a;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:520px;margin:0 auto;padding:16px}
    .card{background:#0b1220;border:1px solid #202a44;border-radius:16px;padding:20px;margin-top:12vh}
    h1{margin:0 0 16px 0}
    label{display:block;font-size:14px;color:#94a3b8;margin:10px 0 6px}
    input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #29324c;background:#0e1629;color:#e5e7eb;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{border:0;background:#2563eb;color:white;border-radius:12px;padding:12px 14px;font-size:16px;font-weight:600;cursor:pointer}
    .status{margin-top:12px;font-size:14px;color:#94a3b8;min-height:1.2em}
    .muted{font-size:12px;color:#93a3c0;margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Ingreso</h1>

    <label>Usuario</label>
    <input id="user" autocomplete="username" />

    <label>Contraseña</label>
    <input id="pass" type="password" autocomplete="current-password" />

    <label>N° de sala</label>
    <input id="room" type="text" inputmode="text" autocapitalize="characters" autocomplete="off" spellcheck="false" maxlength="20" placeholder="ej: A01" />

    <div class="row">
      <button id="go">Tomar fotos</button>
    </div>

    <div class="status" id="msg"></div>
    <div class="muted">Al continuar, la cámara se iniciará automáticamente en la siguiente pantalla.</div>
  </div>
</div>

<script>
  const $user = document.getElementById('user');
  const $pass = document.getElementById('pass');
  const $room = document.getElementById('room');
  const $go   = document.getElementById('go');
  const $msg  = document.getElementById('msg');

  function status(t, ok=true){ $msg.textContent=t; $msg.style.color=ok?'#a7f3d0':'#fecaca'; }
  function normalizeRoom(v){ return (v||'').toUpperCase().trim().replace(/\s+/g,''); }
  function isValidRoom(v){ return /^[A-Z0-9-]{1,20}$/.test(v); }

  
// URL del Flow "Sala más cercana" (trigger HTTP)
  const NEAREST_ROOM_URL = "https://defaultab52009f566c40d1940686e6a61980.d1.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/46e407b51df54c10913b688a04e58952/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=jRqVv7H43uLfquHMkXUPNKz6cm5vB18elZEX6_EdHKc";
  const MAX_METERS_DEFAULT = 1500; // radio por defecto para found/withinMax


  // Autocompletar con última sesión (si existiera)
  (function preload(){
    try{
      const u = sessionStorage.getItem('gl_user')||'';
      const r = sessionStorage.getItem('gl_room')||'';
      $user.value = u;
      $room.value = r;
    }catch{}
  })();

  $go.onclick = ()=>{
    const u = ($user.value||'').trim();
    const p = ($pass.value||'').trim();
    const r = normalizeRoom($room.value);
    if(!u || !p || !isValidRoom(r)){
      status('Completa usuario, contraseña y sala válida (A-Z, 0-9, "-").', false);
      return;
    }
    try{
      sessionStorage.setItem('gl_user', u);
      sessionStorage.setItem('gl_pass', p);
      sessionStorage.setItem('gl_room', r);
    }catch{}
    // Ir a cámara (con token anti-caché)
    location.href = './capture.html?t=' + Date.now();
  };
  
/** ========= Helpers ya existentes / similares en tu index ========= **/

function status(t, ok=true){ 
  if(!$msg) return; 
  $msg.textContent=t; 
  $msg.style.color = ok ? '#a7f3d0' : '#fecaca'; 
}
function normalizeRoom(v){ return (v||'').toUpperCase().trim().replace(/\s+/g,''); }
function isValidRoom(v){ return /^[A-Z0-9\-]{1,20}$/.test(v); }

/** ========= Llamado al flujo SIN preflight (text/plain) ========= **/
async function nearestRoom(lat, lng, maxMeters = MAX_METERS_DEFAULT){
  try{
    const res = await fetch(NEAREST_ROOM_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain; charset=utf-8' }, // <- evita preflight
      body: JSON.stringify({ lat, lng, maxMeters })
    });
    const data = await res.json().catch(()=> ({}));
    return { ok: res.ok && data && data.ok === true, data, status: res.status };
  }catch(e){
    return { ok:false, error: e.message };
  }
}

/** ========= Geolocalización (auto) ========= **/
function getLocationOnce(options){
  return new Promise((resolve, reject) => {
    if (!('geolocation' in navigator)) return reject(new Error('Geolocalización no soportada'));
    navigator.geolocation.getCurrentPosition(
      pos => resolve(pos),
      err => reject(err),
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0, ...(options||{}) }
    );
  });
}

/** ========= Lógica principal al cargar index ========= **/
(async function autoSuggestRoom(){
  try{
    // Mostrar “cargando” suave, sin bloquear al usuario
    status('Buscando sala cercana…');

    // 1) Obtener geolocalización (el navegador pedirá permiso solo la primera vez)
    const pos = await getLocationOnce();
    const { latitude: lat, longitude: lng, accuracy } = pos.coords;

    // 2) Feedback de precisión (opcional)
    if (accuracy && accuracy > 100) {
      status(`Precisión limitada (${Math.round(accuracy)} m). Buscando sala cercana…`);
    }

    // 3) Consultar flujo
    const r = await nearestRoom(lat, lng, MAX_METERS_DEFAULT);
    if (!r.ok) {
      // No bloquear: el usuario aún puede escribir la sala manualmente
      status(`No se pudo sugerir sala (HTTP ${r.status || ''}). Ingresa la sala manualmente.`, false);
      return;
    }

    // 4) Validar respuesta y aplicar sugerencia
    const s = r.data && r.data.sala ? r.data.sala : null;
    if (!r.data.found || !s || !s.roomCode) {
      status('No hay salas dentro del radio. Ingresa la sala manualmente.', false);
      return;
    }

    // 5) Pre‑rellenar el campo Sala y persistir en sessionStorage como en tu app
    $room.value = normalizeRoom(s.roomCode);
    try { 
      sessionStorage.setItem('gl_room', $room.value); 
    } catch {}

    // (Opcional) Persistir usuario/contraseña si ya estaban, para coherencia con tu lógica
    try {
      if ($user && $user.value) sessionStorage.setItem('gl_user', $user.value.trim());
      if ($pass && $pass.value) sessionStorage.setItem('gl_pass', $pass.value.trim());
    } catch {}

    const dist = typeof s.distanceMeters === 'number' ? `${Math.round(s.distanceMeters)} m` : '';
    status(`Sala sugerida: ${$room.value}${dist ? ' · ' + dist : ''}`);
  }catch(e){
    // No bloquear: permitir ingreso manual si falla ubicación
    status(`No se pudo obtener ubicación: ${e.message}. Puedes ingresar la sala manualmente.`, false);
  }
})();

</script>
</body>
</html>
