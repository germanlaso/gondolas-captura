
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Captura de Góndolas</title>
  <style>
    body{margin:0;background:#0f172a;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    .card{background:#0b1220;border:1px solid #202a44;border-radius:16px;padding:16px}
    label{display:block;font-size:14px;color:#94a3b8;margin:8px 0 6px}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #29324c;background:#0e1629;color:#e5e7eb;font-size:16px}
    button{border:0;background:#2563eb;color:white;border-radius:12px;padding:10px 12px;font-size:14px;font-weight:600;cursor:pointer}
    button.secondary{background:#334155}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .videoBox{border-radius:16px;overflow:hidden;background:black;margin-top:12px;border:1px solid #223;min-height:200px}
    video{width:100%;height:auto;display:block}
    .status{margin-top:12px;font-size:14px;color:#94a3b8}
    #gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
    .thumb{position:relative;border:1px solid #223;border-radius:10px;overflow:hidden}
    .thumb img{width:100%;display:block}
    .thumb button{position:absolute;top:4px;right:4px;background:#1f2937;color:#fff;border:0;border-radius:8px;padding:4px 6px;cursor:pointer}
    .diag{margin-top:14px;background:#0a1222;border:1px dashed #2a365a;border-radius:12px;padding:12px}
    .diag h3{margin:0 0 8px 0;font-size:14px;color:#a3bffa}
    .diag pre{white-space:pre-wrap;word-wrap:break-word;background:#0a1329;border:1px solid #1d2847;border-radius:8px;padding:10px;max-height:220px;overflow:auto}
    .build{font-size:12px;color:#60a5fa;margin-bottom:8px}
  </style>
</head>
<body>
<div class="wrap"><div class="card">
  <div class="build">v2-diag – build 2026-01-19</div>
  <h1>Captura de Góndolas</h1>

  <label>Usuario</label>
  <input id="user" autocomplete="username" />
  <label>Contraseña</label>
  <input id="pass" type="password" autocomplete="current-password" />
  <label>N° de sala</label>
  <input id="room" type="text" inputmode="text" autocapitalize="characters" autocomplete="off" spellcheck="false" maxlength="20" placeholder="ej: A01" />

  <div class="row" style="margin-top:8px">
    <button id="btnStart">Iniciar cámara</button>
    <button id="btnCapture" class="secondary" disabled>Capturar</button>
    <button id="btnAddPhoto" class="secondary" disabled>Agregar foto</button>
  </div>

  <div class="videoBox"><video id="camera" autoplay playsinline muted></video><canvas id="snapshot" style="display:none"></canvas></div>

  <div class="row" style="margin-top:10px">
    <button id="btnRetake" class="secondary" disabled>Repetir</button>
    <button id="btnSendBatch">Enviar lote</button>
    <button id="btnRetry" class="secondary">Reintentar ahora</button>
    <button id="btnTestAuth" class="secondary">Probar credenciales</button>
  </div>

  <!-- Galería de fotos pendientes -->
  <div id="gallery"></div>

  <div class="status"><span id="msg">Listo</span><br/><span id="queueMsg">Cola: 0 fotos pendientes | Lotes en envío: 0</span></div>

  <!-- ========== PANEL DE DIAGNÓSTICO ========== -->
  <div class="diag">
    <h3>Diagnóstico</h3>
    <div class="row">
      <button id="btnShowOutbox" class="secondary">Ver outbox</button>
      <button id="btnForceUpdate" class="secondary">Forzar actualización (limpiar SW/Cache)</button>
    </div>
    <pre id="log"></pre>
  </div>
</div></div>

<script>
/* =================== Config =================== */
const FLOW_UPLOAD_URL = "https://defaultab52009f566c40d1940686e6a61980.d1.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/51a6e085ab6f40338b007d0b0925eaa9/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=XRRtlLgS7mtHs9PjkE64NpUyuvbDQXUoe9rP1VawKsc";
const MAX_DIM = 1600, JPEG_QUALITY = 0.82;
const BATCH_MAX_IMAGES = 5;
const RETRY_BASE_MS = 2000, RETRY_MAX_MS = 60000;

/* =================== Estado/UI =================== */
const $user = document.getElementById('user');
const $pass = document.getElementById('pass');
const $room = document.getElementById('room');
const $btnStart = document.getElementById('btnStart');
const $btnCapture = document.getElementById('btnCapture');
const $btnRetake = document.getElementById('btnRetake');
const $btnAddPhoto = document.getElementById('btnAddPhoto');
const $btnSendBatch = document.getElementById('btnSendBatch');
const $btnRetry = document.getElementById('btnRetry');
const $btnTestAuth = document.getElementById('btnTestAuth');
const $btnShowOutbox = document.getElementById('btnShowOutbox');
const $btnForceUpdate = document.getElementById('btnForceUpdate');
const $video = document.getElementById('camera');
const $canvas = document.getElementById('snapshot');
const $msg = document.getElementById('msg');
const $gallery = document.getElementById('gallery');
const $queueMsg = document.getElementById('queueMsg');
const $log = document.getElementById('log');
let stream=null, photoReady=false, currentJpegB64=null;

function status(t, ok=true){ $msg.textContent=t; $msg.style.color=ok?'#a7f3d0':'#fecaca'; log(t); }
function log(...args){ const s = args.map(a=> typeof a==='string'? a : JSON.stringify(a)).join(' '); $log.textContent += (s+'\n'); $log.scrollTop = $log.scrollHeight; }
function normalizeRoom(v){ return (v || "").toUpperCase().trim().replace(/\s+/g,''); }
function isValidRoom(v){ return /^[A-Z0-9-]{1,20}$/.test(v); }

/* =================== Cámara (robusta) =================== */
async function startCamera(){
  if(!$user.value || !$pass.value || !isValidRoom(normalizeRoom($room.value))){
    status('Complete usuario/clave y sala válida', false); return;
  }
  const explain = (err) => {
    if (!err || !err.name) return `Error desconocido al iniciar cámara`;
    switch (err.name) {
      case 'NotAllowedError':
      case 'SecurityError': return 'Acceso a la cámara bloqueado. Habilítalo en el candado del navegador y recarga.';











