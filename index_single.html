<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Captura de Góndolas</title>
  <style>
    body{margin:0;background:#0f172a;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:520px;margin:0 auto;padding:16px}
    .card{background:#0b1220;border:1px solid #202a44;border-radius:16px;padding:16px}
    label{display:block;font-size:14px;color:#94a3b8;margin:8px 0 6px}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #29324c;background:#0e1629;color:#e5e7eb;font-size:16px}
    button{border:0;background:#2563eb;color:white;border-radius:12px;padding:12px 14px;font-size:16px;font-weight:600;cursor:pointer}
    button.secondary{background:#334155}
    .videoBox{border-radius:16px;overflow:hidden;background:black;margin-top:12px;border:1px solid #223}
    video{width:100%;height:auto;display:block}
    .status{margin-top:12px;font-size:14px;color:#94a3b8}
  </style>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>Captura de Góndolas</h1>
  <label>Usuario</label>
  <input id="user" autocomplete="username" />
  <label>Contraseña</label>
  <input id="pass" type="password" autocomplete="current-password" />
  <label>N° de sala</label>
  <input id="room" type="text" inputmode="text" autocapitalize="characters" autocomplete="off" spellcheck="false" maxlength="20" placeholder="ej: A01" />
  <div style="display:flex;gap:10px;margin-top:8px">
    <button id="btnStart">Iniciar cámara</button>
    <button id="btnCapture" class="secondary" disabled>Capturar</button>
  </div>
  <div class="videoBox"><video id="camera" autoplay playsinline muted></video><canvas id="snapshot" style="display:none"></canvas></div>
  <div style="display:flex;gap:10px;margin-top:10px">
    <button id="btnRetake" class="secondary" disabled>Repetir</button>
    <button id="btnSend" disabled>Enviar foto</button>
  </div>
  <div class="status"><span id="msg">Listo</span></div>
</div></div>
<script>
const FLOW_UPLOAD_URL = "https://defaultab52009f566c40d1940686e6a61980.d1.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4aed5c90b202408e94b24dc0fa907459/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=IWhG4QGQtHkv9AqdFYcRccjS38IjPuPPGZ4DKW5Lbpo"; // pegar URL del trigger HTTP
const MAX_DIM = 1600, JPEG_QUALITY = 0.85;
const $user = document.getElementById('user');
const $pass = document.getElementById('pass');
const $room = document.getElementById('room');
const $btnStart = document.getElementById('btnStart');
const $btnCapture = document.getElementById('btnCapture');
const $btnSend = document.getElementById('btnSend');
const $btnRetake = document.getElementById('btnRetake');
const $video = document.getElementById('camera');
const $canvas = document.getElementById('snapshot');
const $msg = document.getElementById('msg');
let stream=null, photoReady=false;
function status(t,ok=true){$msg.textContent=t;$msg.style.color=ok?'#a7f3d0':'#fecaca'}
function normalizeRoom(v){return (v||"").toUpperCase().trim().replace(/\s+/g,'');}
function isValidRoom(v){return /^[A-Z0-9-]{1,20}$/.test(v);}
$room.addEventListener('input',()=>{$room.value=normalizeRoom($room.value)});
async function startCamera(){
  if(!$user.value||!$pass.value||!isValidRoom($room.value)) {status('Complete usuario/clave y sala válida',false);return}
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080}},audio:false});
    $video.srcObject = stream; $btnCapture.disabled=false; status('Cámara lista');
  }catch(e){status('No se pudo acceder a la cámara',false)}
}
function capture(){
  const vw=$video.videoWidth, vh=$video.videoHeight; if(!vw||!vh){status('Cámara no lista',false);return}
  const long=Math.max(vw,vh), scale= long>MAX_DIM? MAX_DIM/long:1;
  const tw=Math.round(vw*scale), th=Math.round(vh*scale);
  $canvas.width=tw; $canvas.height=th; const ctx=$canvas.getContext('2d',{alpha:false});
  ctx.drawImage($video,0,0,tw,th); photoReady=true; $btnSend.disabled=false; $btnRetake.disabled=false; $btnCapture.disabled=true; status('Foto capturada.');
}
function getJpegBase64(){return $canvas.toDataURL('image/jpeg',JPEG_QUALITY).split(',')[1];}
function deviceInfo(){return {ua:navigator.userAgent,platform:navigator.platform,lang:navigator.language};}
async function send(){
  if(!photoReady){status('Capture una foto primero',false);return}
  const payload={user:$user.value.trim(),password:$pass.value.trim(),room_code:normalizeRoom($room.value),client_time:new Date().toISOString(),image_base64:getJpegBase64(),device:deviceInfo()};
  try{
    $btnSend.disabled=true; status('Enviando...');
    const res = await fetch(FLOW_UPLOAD_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const data = await res.json().catch(()=>({ok:res.ok}));
    if(res.ok && data.ok){status('Foto enviada correctamente ✅'); photoReady=false; $btnRetake.disabled=true; $btnCapture.disabled=false;}
    else{status('Error al enviar (credenciales/sala/base64).',false)}
  }catch(e){status('Error de red/servidor',false)} finally{$btnSend.disabled=false}
}
$btnStart.onclick=startCamera; $btnCapture.onclick=capture; $btnRetake.onclick=()=>{$btnSend.disabled=true;$btnRetake.disabled=true;$btnCapture.disabled=false;photoReady=false;status('Repita la captura.')}; $btnSend.onclick=send;
</script>
</body>
</html>

